
***

### **项目开发文档：智能导航首页 (Smart Navigation Homepage)**

---

### **1. 项目概述**

#### **1.1 项目简介**
“智能导航首页”是一个基于 Manifest V3 的浏览器新标签页（New Tab Page）扩展。它旨在取代浏览器默认的空白首页，为用户提供一个高度可定制、美观且高效的网站快速启动器。用户可以自由地将常用网站以图标形式组织在多个标签页下，并通过一个独立、按需生成的报告功能，了解自己的上网习惯。

#### **1.2 项目目标**
*   **高效启动**: 用户可以快速访问最常用的网站，减少搜索或输入URL的时间。
*   **个性化定制**: 提供多样的定制功能，包括多标签分类、图标拖拽排序、自定义名称和简介。
*   **优化的统计**: 提供一个可选的统计报告功能。后台高效记录数据，仅在用户主动查看时进行分析和展示，不干扰核心导航体验。
*   **数据主权**: 用户数据（网站列表和统计信息）完全存储在本地，并提供完整的导入/导出功能，保障用户对个人数据的完全控制。
*   **现代化体验**: 使用 Bootstrap 5 和 SortableJS 构建现代化、响应式且交互友好的用户界面，并遵循 Manifest V3 规范，确保安全性与未来兼容性。
*   **数据兼容性**: 新增了从流行的“WeTab”扩展导入数据的功能，方便用户无缝迁移。

---

### **2. 功能需求详述**

#### **2.1 核心界面与交互**

*   **标签页系统 (Tabs)**
    *   用户可以创建、重命名和删除标签页。
    *   默认至少有一个标签页，例如“主页”。
    *   当前活跃的标签页有视觉上的高亮区分。

*   **图标网格 (Icon Grid)**
    *   每个标签页下有一个响应式的网格布局，用于展示网站图标。
    *   每个图标项包含两个可见元素：网站图标 (Favicon) 和网站名称。
    *   当鼠标悬浮在图标上时，会以 Tooltip 的形式显示用户为此网站填写的简介（若简介为空，则显示网站名称）。

*   **编辑模式 (Edit Mode)**
    *   提供一个全局的“编辑模式”开关。
    *   在此模式下，用户可以使用鼠标拖拽图标，自由改变其在当前标签页内的位置和顺序。此功能通过集成 SortableJS 库实现。
    *   在编辑模式下，单击图标将不会触发页面跳转。

#### **2.2 网站图标管理 (CRUD)**

*   **添加新网站**
    *   通过界面上的“添加”按钮，弹出一个模态框（Modal）。
    *   模态框包含三个输入字段：
        *   **URL (必填)**: 网站的完整链接。
        *   **名称 (必填)**: 用户自定义的显示名称。
        *   **简介 (可选)**: 用于鼠标悬浮时显示的额外信息。

*   **图标获取逻辑**
    *   **第三方API**: 为了提高成功率和效率，系统使用第三方服务 `favicone.com` 来获取网站的 Favicon。
    *   **异步获取**: 当用户在URL输入框中输入内容并移开焦点时，系统在后台异步请求 Favicon，并在模态框内显示加载动画及预览。
    *   **用户优先与请求中止**: 如果在 Favicon 未完成获取时，用户直接点击“保存”按钮，系统将立即中止正在进行的网络请求，并为该网站使用一个预设的默认图标（一个地球图标）进行保存。

*   **修改与删除网站**
    *   **触发方式**: 用户通过在目标网站图标上**单击鼠标右键**来触发编辑操作。默认的浏览器右键菜单将被禁用。
    *   **编辑模态框**: 右键点击后，立即弹出一个与“添加”功能相同的模态框，并预先填充好当前网站的所有信息。
    *   **删除功能**: 在此编辑模态框的底部，提供一个“删除”按钮。点击后，必须弹出一个二次确认对话框。用户确认后，该网站图标及其关联的所有统计数据都将被彻底移除。

#### **2.3 图标缓存机制**

*   **Base64 缓存**: 成功获取到的 Favicon 将被转换为 Base64 编码的字符串，并与网站其他信息一同存储在本地浏览器存储中 (`chrome.storage.local`)。
*   **性能优化**: 首页加载时，直接从本地缓存读取 Base64 图标数据进行渲染，避免了每次加载都重新发起网络请求，从而极大地提升了页面加载速度和离线可用性。

#### **2.4 后台统计与报告**

*   **数据采集**
    *   当用户每次**左键或中键点击**任何一个网站图标时，脚本会记录一次点击事件。
    *   记录内容被聚合到每个图标的统计对象中，包含总点击次数 (`totalClicks`) 和一个包含每次点击时间戳的数组 (`timestamps`)。
    *   此过程在后台静默进行，对用户无感知。

*   **按需生成报告**
    *   分析计算过程仅在用户点击“查看统计报告”按钮时触发。
    *   程序会读取已聚合的统计数据 (`iconStats`)，并实时进行排名计算。

*   **报告展示界面**
    *   提供一个独立的“统计报告”模态框。
    *   报告内容分为两部分：
        *   **全局最常用 Top 10**: 统计所有标签页中，被点击次数最多的10个网站。
        *   **各 TAB 最常用 Top 10**: 提供一个下拉菜单，让用户选择指定的标签页，然后展示该标签页内被点击次数最多的10个网站。
    *   结果以清晰的列表形式展示，包含：排名、图标、网站名称、总点击次数。

#### **2.5 导入与导出功能**

*   **数据格式**:
    *   所有导入导出的数据统一使用 JSON 格式。
    *   JSON 文件将包含一个根对象，内含 `config` (网站配置) 和 `statistics` (统计数据) 两部分。

*   **导出 (Export)**:
    *   提供“导出数据”按钮。
    *   点击后，程序将从 `chrome.storage.local` 读取所有数据，构建成一个完整的 JSON 对象，并将其作为文件（例如 `smart-nav-backup-YYYY-MM-DD.json`）下载到用户本地。

*   **导入 (Import)**:
    *   提供“导入数据”按钮，允许用户选择一个本地的 JSON 文件。
    *   导入前必须向用户明确提示：“导入将覆盖所有现有数据，此操作不可逆，请确认。”
    *   程序会校验文件格式的有效性（特别是新的 `statistics.iconStats` 结构），然后用文件中的数据完全替换现有数据。
    *   导入成功后，自动刷新首页。

*   **从 WeTab 导入 (NEW)**:
    *   新增一项专门的功能，用于从“WeTab”扩展的备份文件 (`.data` 格式) 导入数据。
    *   该功能会自动解析 WeTab 的数据结构，将其分类（Category）映射为本扩展的标签页（Tab），并将其中的网站和文件夹内的网站平铺为图标。
    *   同时，它还会迁移 WeTab 中记录的网站点击次数和最后点击时间。
    *   同样，此操作会覆盖所有现有数据，并有明确的二次确认提示。

---

### **3. 技术架构**

*   **Manifest 版本**: Manifest V3

*   **核心技术栈**:
    *   HTML5, CSS3, JavaScript (ES6+)

*   **UI 框架**:
    *   **Bootstrap 5**: 用于快速构建响应式、美观的 UI 组件（网格、模态框、按钮、Tooltip 等）。

*   **扩展组件**:
    *   `manifest.json`: 扩展的配置文件。
        *   `permissions`: `storage`, `favicon`。
        *   `host_permissions`: `https://favicone.com/*` (用于第三方 Favicon 获取服务)。
        *   `chrome_url_overrides`: `{"newtab": "new_tab.html"}`。
    *   `new_tab.html`: 首页的 HTML 结构。
    *   `new_tab.js`: 核心逻辑，包括 UI 渲染、事件处理、数据管理、与 `chrome.storage` 交互等。
    *   `new_tab.css`: 自定义样式。
    *   `background.js` (Service Worker): 作用轻量，主要负责在扩展首次安装时，初始化本地存储中的默认数据结构。

*   **数据存储**:
    *   `chrome.storage.local`: 作为唯一的数据持久化方案，存储所有用户数据。

*   **第三方库**:
    *   **SortableJS**: 一个轻量、强大的拖拽库，用于实现图标网格内的拖拽排序功能。

---

### **4. 数据结构设计 (JSON 示例)**

这是存储在 `chrome.storage.local` 以及用于导入/导出的 JSON 结构。**注意：`statistics` 的结构已更新**。

```json
{
  "version": "1.0",
  "config": {
    "tabs": [
      {
        "id": "tab-uuid-1",
        "name": "工作",
        "order": 0,
        "icons": [
          {
            "id": "icon-uuid-a",
            "name": "GitHub",
            "url": "https://github.com",
            "description": "代码托管平台",
            "faviconCache": "data:image/png;base64,iVBORw0KGgo...",
            "order": 0
          },
          {
            "id": "icon-uuid-b",
            "name": "Stack Overflow",
            "url": "https://stackoverflow.com",
            "description": "程序员问答社区",
            "faviconCache": "data:image/png;base64,iVBORw0KGgo...",
            "order": 1
          }
        ]
      },
      {
        "id": "tab-uuid-2",
        "name": "娱乐",
        "order": 1,
        "icons": []
      }
    ]
  },
  "statistics": {
    "iconStats": {
      "icon-uuid-a": {
        "totalClicks": 2,
        "timestamps": [1678886400000, 1678886450000]
      },
      "icon-uuid-b": {
        "totalClicks": 1,
        "timestamps": [1678886500000]
      }
    }
  }
}
```

---

### **5. 开发里程碑规划 (已完成)**

*   **第一阶段：基础框架与UI搭建**
    *   已完成：创建 Manifest V3 项目，配置 `new_tab.html`，引入 Bootstrap 5 并实现静态 UI 布局。

*   **第二阶段：核心CRUD功能**
    *   已完成：开发“添加/编辑网站”模态框，集成 `favicone.com` API 进行图标获取，并实现删除功能。
    *   已完成：实现标签页的完整管理功能（增、删、改）。

*   **第三阶段：高级交互集成**
    *   已完成：集成 SortableJS 实现图标拖拽排序，并持久化顺序。
    *   已完成：完善所有交互细节，如 Tooltip、加载状态等。

*   **第四阶段：统计与报告功能**
    *   已完成：实现基于 `iconStats` 新数据结构的点击记录功能。
    *   已完成：创建“统计报告”UI，并编写按需分析逻辑，实现全局和分 TAB 的 Top 10 展示。

*   **第五阶段：数据管理与发布**
    *   已完成：实现完整的 JSON 导出和导入功能（包含对新数据结构的校验）。
    *   **已新增**：实现从 WeTab 备份文件导入数据的功能，增强了用户迁移的便利性。
    *   已完成：进行功能测试和优化。